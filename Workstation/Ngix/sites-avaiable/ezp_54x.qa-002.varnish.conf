server {
    listen                          8080;
    server_name                     ezp_54x.qa-002.dev;

    root                            /var/www/ezp_54x/web;

    ## Don't forget to run php app/console assetic:dump --env=prod
    include                         ez_params.54x.d/ez_prod_rewrite_params;

    # ez rewrite rules
    include                         ez_params.54x.d/ez_rewrite_params;

    location / {
        location ~ ^/(index|index_(rest|cluster|treemenu_tags))\.php(/|$) {
            include ez_params.54x.d/ez_fastcgi_params;

            # FPM socket
            # Possible values : unix:/var/run/php5-fpm.sock or 127.0.0.1:9000
            fastcgi_pass            unix:/run/php/devaneando.sock;

            # Possible values: "prod" and "dev" out-of-the-box, other values possible with proper configuration
            fastcgi_param           ENVIRONMENT prod;

            # Possible values: 0 or 1
            fastcgi_param           USE_DEBUGGING "0";

            # Optional: Whether to use Symfony's builtin HTTP Caching Proxy.
            # Disable it if you are using an external reverse proxy (e.g. Varnish)
            # Possible values: 0 or 1
            fastcgi_param           USE_HTTP_CACHE "0";

            # Optional: Defines the proxies to trust
            # Needed when using Varnish as proxy, if so disable SYMFONY_HTTP_CACHE.
            fastcgi_param           TRUSTED_PROXIES "127.0.0.1,";

        }
    }

    # Custom logs
    access_log                      /var/www/ezp_54x/ezpublish/logs/ezp_54x.access.log devaneando;
    error_log                       /var/www/ezp_54x/ezpublish/logs/ezp_54x.error.log notice;

    include                         ez_params.54x.d/ez_server_params;

}

server {
    listen                          80;
    server_name                     ezp_54x.qa-002.dev;

    location / {
        proxy_pass http://ezp_54x.qa-002.dev:6081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {

    # https://www.digitalocean.com/community/tutorials/how-to-configure-nginx-with-ssl-as-a-reverse-proxy-for-jenkins

    listen                          443 ssl;
    server_name                     ezp_54x.qa-002.dev;

    # add Strict-Transport-Security to prevent man in the middle attacks
    add_header                      Strict-Transport-Security "max-age=31536000";

    ssl_certificate                 /etc/nginx/Cert/qa-002.dev.crt;
    ssl_certificate_key             /etc/nginx/Cert/qa-002.dev.key;

    ssl                             on;
    ssl_session_cache               builtin:1000  shared:SSL:10m;
    ssl_protocols                   TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers                     HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers       on;

    # Custom logs
    access_log                      /var/www/ezp_18x/ezpublish/logs/ezp_18x.access.log devaneando;
    error_log                       /var/www/ezp_18x/ezpublish/logs/ezp_18x.error.log notice;

    location / {

      proxy_set_header              Host $host;
      proxy_set_header              X-Real-IP $remote_addr;
      proxy_set_header              X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header              X-Forwarded-Proto $scheme;

      # Fix the â€œIt appears that your reverse proxy set up is broken" error.
      proxy_pass                    http://ezp_54x.qa-002.dev:6081;
      proxy_read_timeout            90;

    }

}
